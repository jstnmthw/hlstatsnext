# Test infrastructure for integration and E2E tests.
# Usage: docker compose -f docker-compose.test.yml up -d
#
# Services run on non-default ports to avoid conflicts with dev:
#   MySQL    → 3307  (dev: 3306)
#   RabbitMQ → 5673  (dev: 5672)
#   Garnet   → 6380  (dev: 6379)

services:
  mysql-test:
    image: mysql:8.4
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: hlstatsnext_test
      MYSQL_USER: hlstatsnext
      MYSQL_PASSWORD: changeme
    tmpfs:
      - /var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-prootpassword"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - hlstatsnext-test-network

  rabbitmq-test:
    image: rabbitmq:4.1.2-management-alpine
    ports:
      - "5673:5672"
      - "15673:15672"
    environment:
      RABBITMQ_DEFAULT_USER: hlstats
      RABBITMQ_DEFAULT_PASS: hlstats
      RABBITMQ_DEFAULT_VHOST: hlstats
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - hlstatsnext-test-network

  garnet-test:
    image: ghcr.io/microsoft/garnet:latest
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD-SHELL", "echo PING | nc localhost 6379 | grep PONG"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    networks:
      - hlstatsnext-test-network

networks:
  hlstatsnext-test-network:
    driver: bridge
